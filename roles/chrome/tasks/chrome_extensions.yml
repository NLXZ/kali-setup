---
- name: "Deploy extension settings"
  ansible.builtin.template:
    src: "extensions.json.j2"
    dest: "/etc/opt/chrome/policies/managed/extensions.json"
    force: false
    owner: root
    group: root
    mode: '0644'
  tags:
    - chrome

- name: "Start chrome (headless)"
  ansible.builtin.shell: |
    set -o pipefail
    Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
    DISPLAY=:99 google-chrome --no-sandbox --disable-gpu > /dev/null 2>&1 &
  async: 0
  poll: 0
  changed_when: false
  become: true
  become_user: "{{ lookup('pipe', 'id -nu 1000') }}"
  tags:
    - chrome

- name: "Wait for extensions to be installed"
  ansible.builtin.shell: |
    set -o pipefail

    profile="$HOME/.config/google-chrome/Default"
    ext_id="{{ item.id }}"
    ext_dir="$profile/Extensions/$ext_id"
    ext_cfg="$profile/Local Extension Settings/$ext_id"

    if [[ -d "$ext_dir" && -d "$ext_cfg" ]]; then
      exit 0
    fi

    timeout 120 bash -c "while [[ ! -d '$ext_dir' ]]; do sleep 1; done" || exit 1

    url=$(find "$ext_dir" -name 'options.html' | cut -d/ -f10-)
    google-chrome "chrome-extension://$ext_id/$url"

    timeout 120 bash -c "while [[ ! -d '$ext_cfg' ]]; do sleep 1; done" || exit 1

    echo "Installed: $id"
  register: chrome_wait
  changed_when: "'Installed' in chrome_wait.stdout"
  loop: "{{ chrome_extensions }}"
  loop_control:
    label: "{{ item.name }}"
  become: true
  become_user: "{{ lookup('pipe', 'id -nu 1000') }}"
  tags:
    - chrome

- name: "Stop chrome"
  ansible.builtin.command: "killall -w chrome Xvfb"
  register: chrome_stop
  changed_when: "chrome_stop.rc == 0"
  become: true
  become_user: "{{ lookup('pipe', 'id -nu 1000') }}"
  tags:
    - chrome

- name: "Copy extensions configuration"
  ansible.builtin.copy:
    src: files/extensions
    dest: /tmp
    owner: "{{ lookup('pipe', 'id -nu 1000') }}"
    group: "{{ lookup('pipe', 'id -nu 1000') }}"
    mode: '755'
  tags:
    - chrome

- name: "Configure extensions"
  ansible.builtin.shell: |
    set -o pipefail
    cd /tmp/extensions
    npm install level
    node chrome_ext.js config/{{ item.name }}.json {{ item.id }}
  changed_when: false
  loop: "{{ chrome_extensions }}"
  loop_control:
    label: "{{ item.name }}"
  become: true
  become_user: "{{ lookup('pipe', 'id -nu 1000') }}"
  tags:
    - chrome
