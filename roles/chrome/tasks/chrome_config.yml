---
- name: "Create configuration directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop: "{{ chrome_directories }}"
  loop_control:
    label: "{{ item }}"
  tags:
    - chrome

- name: "Deploy configuration files"
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: '644'
  loop: "{{ chrome_files }}"
  loop_control:
    label: "{{ item.dest }}"
  tags:
    - chrome

- name: "Create user profile"
  ansible.builtin.shell: |
    set -o pipefail
    Xvfb :99 -screen 0 1920x1080x24 &
    timeout 2 sh -c 'DISPLAY=:99 google-chrome --no-sandbox --disable-gpu' &
  args:
    creates: "$HOME/.config/google-chrome/Default"
  async: 5
  poll: 0
  become: true
  become_user: "{{ lookup('pipe', 'id -nu 1000') }}"
  tags:
    - chrome
