---
- name: "[user] Request username"
  ansible.builtin.pause:
    prompt: "Enter the new username (leave blank to skip)"
  register: "user_name"
  tags:
    - user

- name: "[user] Request password"
  ansible.builtin.pause:
    prompt: "Enter the new password (leave blank to skip)"
    echo: false
  register: "user_pass"
  tags:
    - user

- name: "[user] Get current username"
  ansible.builtin.command: |
    id -nu 1000
  register: user_current
  when: user_name is defined and user_name != ''
  changed_when: false
  tags:
    - user

- name: "[user] Change username"
  ansible.builtin.shell: |
    set -o pipefail
    killall -u "{{ user_current.stdout }}"
    usermod -l "{{ user_name }}" "{{ user_current.stdout }}"
    usermod -d "/home/{{ user_name }}" -m "{{ user_name }}"
    groupmod -n "{{ user_name }}" "{{ user_current.stdout }}"
  when: user_name is defined and user_name != ''
  changed_when: "{{ user_name }} != {{ user_current.stdout }}"
  tags:
    - user

- name: "[user] Change password"
  ansible.builtin.user:
    name: "{{ user_name | default(user_current.stdout) }}"
    password: "{{ user_pass | password_hash('sha512') }}"
  when: user_pass is defined and user_pass != ''
  changed_when: "user_pass is defined and user_pass != ''"
  tags:
    - user
